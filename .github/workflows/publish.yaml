name: publish

on:
  workflow_call:
    secrets:
      CARGO_REGISTRY_TOKEN:
        required: true
      PYPI_API_TOKEN:
        required: true
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform a dry run without actually publishing'
        required: false
        type: boolean
        default: false

concurrency:
  group: publish-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write # required to push tags

defaults:
  run:
    shell: bash

jobs:

  publish-rust:
    name: Publish Rust Core
    if: ${{ needs.prepare.outputs.should_publish == 'true' }}
    uses: ./.github/workflows/_publish-rust.yaml
    with:
      version: ${{ needs.prepare.outputs.version }}
      dry_run: ${{ needs.prepare.outputs.dry_run == 'true' }}
    secrets:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  publish-python:
    name: Publish Python Bindings
    needs: [publish-rust]
    if: ${{ needs.prepare.outputs.should_publish == 'true' }}
    uses: ./.github/workflows/_publish-python.yaml
    with:
      version: ${{ needs.prepare.outputs.version }}
      dry_run: ${{ needs.prepare.outputs.dry_run == 'true' }}
    secrets:
      PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

  dry-run-summary:
    name: Dry-run Summary
    needs: [publish-rust, publish-python]
    if: ${{ needs.prepare.outputs.should_publish == 'true' && needs.prepare.outputs.dry_run == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "üîç Dry-run completed successfully!"
          echo "Version: ${{ needs.prepare.outputs.version }}"
          echo "All packages built successfully but not published."
          echo "To publish for real, run this workflow without dry_run or push to main."


